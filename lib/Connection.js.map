{"version":3,"sources":["../src/Connection.mjs"],"names":["value","then","direct","Promise","resolve","Pop3Connection","host","port","tls","timeout","_socket","_stream","_command","Readable","read","buffer","TERMINATOR_BUFFER_ARRAY","some","_buffer","equals","_endStream","endBuffer","slice","TERMINATOR_BUFFER","push","err","emit","socket","Socket","setKeepAlive","reject","setTimeout","Error","eventName","listeners","length","end","_tls","connect","rejectUnauthorized","on","_pushStream","command","firstLineEndIndex","indexOf","CRLF_BUFFER","infoBuffer","split","commandName","stream","MULTI_LINE_COMMAND_NAME","includes","_updateStream","bodyBuffer","toString","once","args","join","rejectFn","info","removeListener","write","CRLF","EventEmitter"],"mappings":"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","sourcesContent":["import { Socket } from 'net';\nimport _tls from 'tls';\nimport { EventEmitter } from 'events';\nimport { Readable } from 'stream';\n\nimport {\n  CRLF,\n  CRLF_BUFFER,\n  TERMINATOR_BUFFER,\n  TERMINATOR_BUFFER_ARRAY,\n  MULTI_LINE_COMMAND_NAME\n} from './constant.mjs';\n\nclass Pop3Connection extends EventEmitter {\n  constructor({\n    host,\n    port,\n    tls,\n    timeout,\n  }) {\n    super();\n    this.host = host;\n    this.port = port || (tls ? 995 : 110);\n    this.tls = tls;\n    this.timeout = timeout;\n    this._socket = null;\n    this._stream = null;\n    this._command;\n  }\n\n  _updateStream() {\n    this._stream = new Readable({\n      read: () => {},\n    });\n    return this._stream;\n  }\n\n  _pushStream(buffer) {\n    if (TERMINATOR_BUFFER_ARRAY.some((_buffer) => _buffer.equals(buffer))) {\n      return this._endStream();\n    }\n    const endBuffer = buffer.slice(-5);\n    if (endBuffer.equals(TERMINATOR_BUFFER)) {\n      this._stream.push(buffer.slice(0, -5));\n      return this._endStream();\n    }\n    this._stream.push(buffer);\n  }\n\n  _endStream(err) {\n    if (this._stream) {\n      this._stream.push(null);\n    }\n    this._stream = null;\n    this.emit('end', err);\n  }\n\n  connect() {\n    const { host, port } = this;\n    const socket = new Socket();\n    socket.setKeepAlive(true);\n    return new Promise((resolve, reject) => {\n      if (typeof this.timeout !== 'undefined') {\n        socket.setTimeout(this.timeout, () => {\n          const err = new Error('timeout');\n          err.eventName = 'timeout';\n          reject(err);\n          if (this.listeners('end').length) {\n            this.emit('end', err);\n          }\n          if (this.listeners('error').length) {\n            this.emit('error', err);\n          }\n          this._socket.end();\n          this._socket = null;\n        });\n      }\n      if (this.tls) {\n        this._socket = _tls.connect({\n          host,\n          port,\n          socket,\n          rejectUnauthorized: false\n        });\n      } else {\n        this._socket = socket;\n      }\n\n      this._socket.on('data', (buffer) => {\n        if (this._stream) {\n          return this._pushStream(buffer);\n        }\n        if (buffer[0] === 45) { // '-'\n          const err = new Error(buffer.slice(5, -2));\n          err.eventName = 'error';\n          err.command = this._command;\n          return this.emit('error', err);\n        }\n        if (buffer[0] === 43) { // '+'\n          const firstLineEndIndex = buffer.indexOf(CRLF_BUFFER);\n          const infoBuffer = buffer.slice(4, firstLineEndIndex);\n          const [commandName] = (this._command || '').split(' ');\n          let stream = null;\n          if (MULTI_LINE_COMMAND_NAME.includes(commandName)) {\n            this._updateStream();\n            stream = this._stream;\n            const bodyBuffer = buffer.slice(firstLineEndIndex + 2);\n            if (bodyBuffer[0]) {\n              this._pushStream(bodyBuffer);\n            }\n          }\n          this.emit('response', infoBuffer.toString(), stream);\n          resolve();\n          return;\n        }\n        const err = new Error('Unexpected response');\n        err.eventName = 'bad-server-response';\n        reject(err);\n      });\n      this._socket.on('error', (err) => {\n        err.eventName = 'error';\n        if (this._stream) {\n          this.emit('error', err);\n          return;\n        }\n        reject(err);\n        this._socket = null;\n      });\n      this._socket.once('close', () => {\n        const err = new Error('close');\n        err.eventName = 'close';\n        reject(err);\n        this._socket = null;\n      });\n      this._socket.once('end', () => {\n        const err = new Error('end');\n        err.eventName = 'end';\n        reject(err);\n        this._socket = null;\n      });\n      socket.connect({\n        host,\n        port,\n      });\n    });\n  }\n\n  async command(...args) {\n    this._command = args.join(' ');\n    if (!this._socket) {\n      throw new Error('no-socket');\n    }\n    await new Promise((resolve, reject) => {\n      if (!this._stream) {\n        return resolve();\n      }\n      this.once('error', (err) => {\n        return reject(err);\n      });\n      this.once('end', (err) => {\n        return err ? reject(err) : resolve();\n      });\n    });\n    return new Promise((resolve, reject) => {\n      const rejectFn = (err) => reject(err);\n      this.once('error', rejectFn);\n      this.once('response', (info, stream) => {\n        this.removeListener('error', rejectFn);\n        resolve([info, stream]);\n      });\n      if (!this._socket) {\n        reject(new Error('no-socket'));\n      }\n      this._socket.write(`${this._command}${CRLF}`, 'utf8');\n    });\n  }\n}\n\nexport default Pop3Connection;\n"],"file":"Connection.js"}